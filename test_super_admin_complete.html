<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Super Admin Complet</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #0b0b0c; color: #eaeaea; }
        .container { max-width: 1000px; margin: 0 auto; }
        .result { background: #111214; padding: 15px; margin: 10px 0; border-radius: 8px; border: 1px solid #1b1c1f; }
        .error { background: #2d1b1b; border-color: #dc2626; color: #fca5a5; }
        .success { background: #1b2d1b; border-color: #16a34a; color: #86efac; }
        .info { background: #1b1d2d; border-color: #2563eb; color: #93c5fd; }
        pre { white-space: pre-wrap; background: #0a0a0a; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #6b7280; cursor: not-allowed; }
        .test-section { border: 1px solid #374151; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .credentials { background: #1a1b1e; padding: 15px; border-radius: 6px; margin: 10px 0; font-family: monospace; }
        .status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status.success { background: #16a34a; color: white; }
        .status.error { background: #dc2626; color: white; }
        .status.pending { background: #f59e0b; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üëë Test Super Admin Complet</h1>
        <p>V√©rification compl√®te des fonctionnalit√©s Super Admin</p>
        
        <div id="results"></div>
        
        <div class="test-section">
            <h3>üîê Connexion</h3>
            <div class="credentials">
                <strong>Super Admin:</strong> gilles.guerrin@a2display.fr<br>
                <strong>Operator:</strong> gilles.guerrin49@gmail.com
            </div>
            <button onclick="testSuperAdminLogin()" id="loginBtn">Se connecter en Super Admin</button>
            <button onclick="testOperatorLogin()" id="operatorLoginBtn">Se connecter en Operator</button>
            <button onclick="logout()" id="logoutBtn" disabled>Se d√©connecter</button>
        </div>

        <div class="test-section">
            <h3>üè¢ Gestion des Organisations</h3>
            <button onclick="testCreateOrganization()" id="createOrgBtn" disabled>Cr√©er une organisation</button>
            <button onclick="testListOrganizations()" id="listOrgBtn" disabled>Lister les organisations</button>
            <button onclick="testUpdateOrganization()" id="updateOrgBtn" disabled>Modifier une organisation</button>
            <button onclick="testDeleteOrganization()" id="deleteOrgBtn" disabled>Supprimer une organisation</button>
        </div>

        <div class="test-section">
            <h3>üë§ Gestion des Utilisateurs</h3>
            <button onclick="testCreateUser()" id="createUserBtn" disabled>Cr√©er un utilisateur</button>
            <button onclick="testListUsers()" id="listUsersBtn" disabled>Lister les utilisateurs</button>
        </div>

        <div class="test-section">
            <h3>üë• Gestion des Membres</h3>
            <button onclick="testAddMember()" id="addMemberBtn" disabled>Ajouter un membre</button>
            <button onclick="testListMembers()" id="listMembersBtn" disabled>Lister les membres</button>
            <button onclick="testRemoveMember()" id="removeMemberBtn" disabled>Retirer un membre</button>
        </div>

        <div class="test-section">
            <h3>‚öΩ Gestion des Matchs</h3>
            <button onclick="testCreateMatch()" id="createMatchBtn" disabled>Cr√©er un match</button>
            <button onclick="testListMatches()" id="listMatchesBtn" disabled>Lister tous les matchs</button>
            <button onclick="testDeleteMatch()" id="deleteMatchBtn" disabled>Supprimer un match</button>
        </div>

        <div class="test-section">
            <h3>üîç V√©rifications</h3>
            <button onclick="testPermissions()" id="testPermsBtn" disabled>Tester les permissions</button>
            <button onclick="compareWithOperator()" id="compareBtn" disabled>Comparer avec Operator</button>
            <button onclick="runAllTests()" id="runAllBtn" disabled>Ex√©cuter tous les tests</button>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://opwjfpybcgtgcvldizar.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wd2pmcHliY2d0Z2N2bGRpemFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0OTQ5MTksImV4cCI6MjA3MzA3MDkxOX0.8yrYMlhFmjAF5_LG9FtCx8XrJ1sFOz2YejDDupbhgpY';

        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        const resultsDiv = document.getElementById('results');
        let currentUser = null;
        let testData = { orgId: null, userId: null, matchId: null };

        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            resultsDiv.appendChild(div);
        }

        function updateButtonStatus() {
            const isLoggedIn = !!currentUser;
            const buttons = ['loginBtn', 'operatorLoginBtn', 'createOrgBtn', 'listOrgBtn', 'updateOrgBtn', 
                           'deleteOrgBtn', 'createUserBtn', 'listUsersBtn', 'addMemberBtn', 'listMembersBtn', 
                           'removeMemberBtn', 'createMatchBtn', 'listMatchesBtn', 'deleteMatchBtn', 
                           'testPermsBtn', 'compareBtn', 'runAllBtn'];
            
            buttons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (btnId === 'loginBtn' || btnId === 'operatorLoginBtn') {
                        btn.disabled = isLoggedIn;
                    } else {
                        btn.disabled = !isLoggedIn;
                    }
                }
            });
            
            document.getElementById('logoutBtn').disabled = !isLoggedIn;
        }

        async function testSuperAdminLogin() {
            try {
                addResult('üîê Connexion Super Admin', 'Tentative de connexion...', 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'gilles.guerrin@a2display.fr',
                    password: prompt('Mot de passe pour gilles.guerrin@a2display.fr:')
                });

                if (error) {
                    addResult('‚ùå Erreur de connexion', error.message, 'error');
                    return;
                }

                currentUser = data.user;
                addResult('‚úÖ Connexion Super Admin r√©ussie', 
                    `Utilisateur: ${data.user.email}\n` +
                    `ID: ${data.user.id}\n` +
                    `Email confirm√©: ${data.user.email_confirmed_at ? 'Oui' : 'Non'}`, 
                    'success');
                
                updateButtonStatus();
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testOperatorLogin() {
            try {
                addResult('üîê Connexion Operator', 'Tentative de connexion...', 'info');
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'gilles.guerrin49@gmail.com',
                    password: prompt('Mot de passe pour gilles.guerrin49@gmail.com:')
                });

                if (error) {
                    addResult('‚ùå Erreur de connexion', error.message, 'error');
                    return;
                }

                currentUser = data.user;
                addResult('‚úÖ Connexion Operator r√©ussie', 
                    `Utilisateur: ${data.user.email}\n` +
                    `ID: ${data.user.id}`, 
                    'success');
                
                updateButtonStatus();
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            currentUser = null;
            addResult('üö™ D√©connexion', 'Utilisateur d√©connect√©', 'info');
            updateButtonStatus();
        }

        async function testCreateOrganization() {
            try {
                const orgName = prompt('Nom de l\'organisation:') || 'Test Org';
                const orgSlug = prompt('Slug de l\'organisation:') || 'test-org';
                
                addResult('üè¢ Cr√©ation d\'organisation', `Cr√©ation: ${orgName} (${orgSlug})`, 'info');
                
                const { data, error } = await supabase
                    .from('orgs')
                    .insert({
                        name: orgName,
                        slug: orgSlug
                    })
                    .select('*')
                    .single();

                if (error) {
                    addResult('‚ùå Erreur cr√©ation organisation', error.message, 'error');
                    return;
                }

                testData.orgId = data.id;
                addResult('‚úÖ Organisation cr√©√©e', 
                    `ID: ${data.id}\n` +
                    `Nom: ${data.name}\n` +
                    `Slug: ${data.slug}`, 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testListOrganizations() {
            try {
                addResult('üìã Liste des organisations', 'R√©cup√©ration...', 'info');
                
                const { data, error } = await supabase
                    .from('orgs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    addResult('‚ùå Erreur liste organisations', error.message, 'error');
                    return;
                }

                addResult('‚úÖ Organisations r√©cup√©r√©es', 
                    `Nombre: ${data.length}\n` +
                    data.map(org => `- ${org.name} (${org.slug}) - ID: ${org.id}`).join('\n'), 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testCreateUser() {
            try {
                const email = prompt('Email du nouvel utilisateur:') || 'test@example.com';
                const password = prompt('Mot de passe:') || 'test123';
                
                addResult('üë§ Cr√©ation d\'utilisateur', `Cr√©ation: ${email}`, 'info');
                
                const { data, error } = await supabase.auth.admin.createUser({
                    email: email,
                    password: password,
                    email_confirm: true
                });

                if (error) {
                    addResult('‚ùå Erreur cr√©ation utilisateur', error.message, 'error');
                    return;
                }

                testData.userId = data.user.id;
                addResult('‚úÖ Utilisateur cr√©√©', 
                    `ID: ${data.user.id}\n` +
                    `Email: ${data.user.email}`, 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testListUsers() {
            try {
                addResult('üë• Liste des utilisateurs', 'R√©cup√©ration...', 'info');
                
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    addResult('‚ùå Erreur liste utilisateurs', error.message, 'error');
                    return;
                }

                addResult('‚úÖ Utilisateurs r√©cup√©r√©s', 
                    `Nombre: ${data.length}\n` +
                    data.map(user => `- ${user.email} - ID: ${user.id}`).join('\n'), 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testAddMember() {
            try {
                if (!testData.orgId || !testData.userId) {
                    addResult('‚ùå Donn√©es manquantes', 'Cr√©ez d\'abord une organisation et un utilisateur', 'error');
                    return;
                }
                
                addResult('üë• Ajout d\'un membre', 'Ajout en cours...', 'info');
                
                const { data, error } = await supabase
                    .from('org_members')
                    .insert({
                        org_id: testData.orgId,
                        user_id: testData.userId,
                        role: 'operator'
                    })
                    .select('*')
                    .single();

                if (error) {
                    addResult('‚ùå Erreur ajout membre', error.message, 'error');
                    return;
                }

                addResult('‚úÖ Membre ajout√©', 
                    `Organisation: ${data.org_id}\n` +
                    `Utilisateur: ${data.user_id}\n` +
                    `R√¥le: ${data.role}`, 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testCreateMatch() {
            try {
                if (!testData.orgId) {
                    addResult('‚ùå Organisation manquante', 'Cr√©ez d\'abord une organisation', 'error');
                    return;
                }
                
                addResult('‚öΩ Cr√©ation d\'un match', 'Cr√©ation en cours...', 'info');
                
                const { data, error } = await supabase
                    .from('matches')
                    .insert({
                        org_id: testData.orgId,
                        name: 'Test Match Super Admin',
                        sport: 'football',
                        home_name: 'Test Home',
                        away_name: 'Test Away',
                        scheduled_at: new Date().toISOString(),
                        status: 'scheduled',
                        public_display: true,
                        display_token: Math.random().toString(36).substring(2, 15)
                    })
                    .select('*')
                    .single();

                if (error) {
                    addResult('‚ùå Erreur cr√©ation match', error.message, 'error');
                    return;
                }

                testData.matchId = data.id;
                addResult('‚úÖ Match cr√©√©', 
                    `ID: ${data.id}\n` +
                    `Nom: ${data.name}\n` +
                    `Organisation: ${data.org_id}\n` +
                    `Sport: ${data.sport}`, 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testPermissions() {
            try {
                addResult('üîç Test des permissions', 'V√©rification...', 'info');
                
                // Test acc√®s organisations
                const { data: orgs, error: orgsError } = await supabase
                    .from('orgs')
                    .select('*');

                if (orgsError) {
                    addResult('‚ùå Erreur acc√®s organisations', orgsError.message, 'error');
                    return;
                }

                // Test acc√®s matchs
                const { data: matches, error: matchesError } = await supabase
                    .from('matches')
                    .select('*');

                if (matchesError) {
                    addResult('‚ùå Erreur acc√®s matchs', matchesError.message, 'error');
                    return;
                }

                // Test acc√®s profils
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('*');

                if (profilesError) {
                    addResult('‚ùå Erreur acc√®s profils', profilesError.message, 'error');
                    return;
                }

                addResult('‚úÖ Permissions v√©rifi√©es', 
                    `Organisations accessibles: ${orgs.length}\n` +
                    `Matchs accessibles: ${matches.length}\n` +
                    `Profils accessibles: ${profiles.length}\n\n` +
                    `‚úÖ Acc√®s global confirm√© pour Super Admin`, 
                    'success');
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function runAllTests() {
            addResult('üöÄ Ex√©cution de tous les tests', 'D√©marrage...', 'info');
            
            await testListOrganizations();
            await testListUsers();
            await testPermissions();
            
            addResult('‚úÖ Tous les tests termin√©s', 'V√©rification compl√®te effectu√©e', 'success');
        }

        // Initialisation
        updateButtonStatus();
    </script>
</body>
</html>
