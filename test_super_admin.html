<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Super Admin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        pre { white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #1976d2; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üîß Test Super Admin - V√©rification des permissions</h1>
    <div id="results"></div>
    
    <div class="test-section">
        <h3>1. Connexion Super Admin</h3>
        <input type="email" id="email" placeholder="Email Super Admin" value="gilles.guerrin@a2display.fr" style="width: 300px; padding: 8px; margin: 5px;">
        <input type="password" id="password" placeholder="Mot de passe" style="width: 300px; padding: 8px; margin: 5px;">
        <button onclick="testSuperAdminLogin()">Se connecter</button>
    </div>

    <div class="test-section">
        <h3>2. Tests de permissions</h3>
        <button onclick="testSuperAdminPermissions()" id="testPermsBtn" disabled>Tester les permissions</button>
        <button onclick="testAllOrganizations()" id="testOrgsBtn" disabled>Tester acc√®s toutes organisations</button>
        <button onclick="testCreateMatch()" id="testCreateBtn" disabled>Cr√©er un match test</button>
        <button onclick="testDeleteMatch()" id="testDeleteBtn" disabled>Supprimer match test</button>
    </div>

    <div class="test-section">
        <h3>3. Comparaison avec Operator</h3>
        <button onclick="testOperatorLogin()">Tester connexion Operator</button>
        <button onclick="comparePermissions()" id="compareBtn" disabled>Comparer permissions</button>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://opwjfpybcgtgcvldizar.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9wd2pmcHliY2d0Z2N2bGRpemFyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0OTQ5MTksImV4cCI6MjA3MzA3MDkxOX0.8yrYMlhFmjAF5_LG9FtCx8XrJ1sFOz2YejDDupbhgpY';

        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        const resultsDiv = document.getElementById('results');
        let currentUser = null;
        let testMatchId = null;

        function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            resultsDiv.appendChild(div);
        }

        async function testSuperAdminLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                addResult('‚ùå Erreur', 'Email et mot de passe requis', 'error');
                return;
            }

            try {
                addResult('üîê Connexion Super Admin', `Tentative de connexion avec ${email}...`, 'info');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    addResult('‚ùå Erreur de connexion', error.message, 'error');
                    return;
                }

                if (data.user) {
                    currentUser = data.user;
                    addResult('‚úÖ Connexion r√©ussie', 
                        `Utilisateur connect√©: ${data.user.email}\n` +
                        `ID: ${data.user.id}\n` +
                        `Email confirm√©: ${data.user.email_confirmed_at ? 'Oui' : 'Non'}`, 
                        'success');
                    
                    // Activer les boutons de test
                    document.getElementById('testPermsBtn').disabled = false;
                    document.getElementById('testOrgsBtn').disabled = false;
                    document.getElementById('testCreateBtn').disabled = false;
                    document.getElementById('testDeleteBtn').disabled = false;
                    document.getElementById('compareBtn').disabled = false;
                }
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testSuperAdminPermissions() {
            if (!currentUser) {
                addResult('‚ùå Erreur', 'Veuillez d\'abord vous connecter', 'error');
                return;
            }

            try {
                addResult('üîç Test des permissions Super Admin', 'V√©rification des acc√®s...', 'info');

                // 1. V√©rifier les organisations accessibles
                const { data: orgMembers, error: orgError } = await supabase
                    .from('org_members_with_org')
                    .select('*')
                    .eq('user_id', currentUser.id);

                if (orgError) {
                    addResult('‚ùå Erreur organisations', orgError.message, 'error');
                    return;
                }

                addResult('üè¢ Organisations accessibles', 
                    `Nombre: ${orgMembers.length}\n` +
                    orgMembers.map(om => `- ${om.org_name} (${om.org_slug}) - R√¥le: ${om.role}`).join('\n'), 
                    'success');

                // 2. V√©rifier les matchs accessibles
                const { data: matches, error: matchesError } = await supabase
                    .from('matches')
                    .select('*');

                if (matchesError) {
                    addResult('‚ùå Erreur matchs', matchesError.message, 'error');
                    return;
                }

                addResult('‚öΩ Matchs accessibles', 
                    `Nombre total: ${matches.length}\n` +
                    matches.map(m => `- ${m.name} (${m.sport}) - Org: ${m.org_id} - Statut: ${m.status}`).join('\n'), 
                    'success');

                // 3. V√©rifier les profils accessibles
                const { data: profiles, error: profilesError } = await supabase
                    .from('profiles')
                    .select('*');

                if (profilesError) {
                    addResult('‚ùå Erreur profils', profilesError.message, 'error');
                    return;
                }

                addResult('üë§ Profils accessibles', 
                    `Nombre: ${profiles.length}\n` +
                    profiles.map(p => `- ${p.email} (${p.id})`).join('\n'), 
                    'success');

            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testAllOrganizations() {
            if (!currentUser) {
                addResult('‚ùå Erreur', 'Veuillez d\'abord vous connecter', 'error');
                return;
            }

            try {
                addResult('üåê Test acc√®s toutes organisations', 'V√©rification des permissions globales...', 'info');

                // Tenter d'acc√©der √† toutes les organisations
                const { data: allOrgs, error: allOrgsError } = await supabase
                    .from('orgs')
                    .select('*');

                if (allOrgsError) {
                    addResult('‚ùå Erreur acc√®s organisations', allOrgsError.message, 'error');
                    return;
                }

                addResult('‚úÖ Acc√®s toutes organisations', 
                    `Organisations accessibles: ${allOrgs.length}\n` +
                    allOrgs.map(org => `- ${org.name} (${org.slug}) - ID: ${org.id}`).join('\n'), 
                    'success');

                // Tenter d'acc√©der aux membres de toutes les organisations
                const { data: allMembers, error: allMembersError } = await supabase
                    .from('org_members')
                    .select('*');

                if (allMembersError) {
                    addResult('‚ùå Erreur acc√®s membres', allMembersError.message, 'error');
                    return;
                }

                addResult('‚úÖ Acc√®s tous les membres', 
                    `Membres accessibles: ${allMembers.length}\n` +
                    allMembers.map(m => `- User ${m.user_id} dans org ${m.org_id} (${m.role})`).join('\n'), 
                    'success');

            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testCreateMatch() {
            if (!currentUser) {
                addResult('‚ùå Erreur', 'Veuillez d\'abord vous connecter', 'error');
                return;
            }

            try {
                addResult('‚ûï Test cr√©ation match', 'Cr√©ation d\'un match test...', 'info');

                // R√©cup√©rer une organisation
                const { data: orgs, error: orgsError } = await supabase
                    .from('orgs')
                    .select('*')
                    .limit(1);

                if (orgsError || !orgs.length) {
                    addResult('‚ùå Erreur organisation', 'Aucune organisation trouv√©e', 'error');
                    return;
                }

                const org = orgs[0];
                const testMatchData = {
                    org_id: org.id,
                    name: 'Test Super Admin Match',
                    sport: 'football',
                    home_name: 'Test Home',
                    away_name: 'Test Away',
                    scheduled_at: new Date().toISOString(),
                    status: 'scheduled',
                    public_display: true,
                    display_token: Math.random().toString(36).substring(2, 15)
                };

                const { data: match, error: matchError } = await supabase
                    .from('matches')
                    .insert(testMatchData)
                    .select('*')
                    .single();

                if (matchError) {
                    addResult('‚ùå Erreur cr√©ation match', matchError.message, 'error');
                    return;
                }

                testMatchId = match.id;
                addResult('‚úÖ Match cr√©√© avec succ√®s', 
                    `Match ID: ${match.id}\n` +
                    `Nom: ${match.name}\n` +
                    `Organisation: ${org.name}\n` +
                    `Sport: ${match.sport}\n` +
                    `Statut: ${match.status}`, 
                    'success');

            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testDeleteMatch() {
            if (!currentUser) {
                addResult('‚ùå Erreur', 'Veuillez d\'abord vous connecter', 'error');
                return;
            }

            if (!testMatchId) {
                addResult('‚ùå Erreur', 'Aucun match test √† supprimer. Cr√©ez d\'abord un match.', 'error');
                return;
            }

            try {
                addResult('üóëÔ∏è Test suppression match', `Suppression du match ${testMatchId}...`, 'info');

                const { error: deleteError } = await supabase
                    .from('matches')
                    .delete()
                    .eq('id', testMatchId);

                if (deleteError) {
                    addResult('‚ùå Erreur suppression match', deleteError.message, 'error');
                    return;
                }

                addResult('‚úÖ Match supprim√© avec succ√®s', 
                    `Match ID ${testMatchId} supprim√©`, 
                    'success');

                testMatchId = null;

            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function testOperatorLogin() {
            try {
                addResult('üîê Test connexion Operator', 'Tentative de connexion avec gilles.guerrin49@gmail.com...', 'info');

                const { data, error } = await supabase.auth.signInWithPassword({
                    email: 'gilles.guerrin49@gmail.com',
                    password: 'test123' // Vous devrez fournir le vrai mot de passe
                });

                if (error) {
                    addResult('‚ùå Erreur connexion Operator', error.message, 'error');
                    return;
                }

                if (data.user) {
                    addResult('‚úÖ Connexion Operator r√©ussie', 
                        `Utilisateur: ${data.user.email}\n` +
                        `ID: ${data.user.id}`, 
                        'success');
                }
            } catch (err) {
                addResult('‚ùå Erreur inattendue', err.message, 'error');
            }
        }

        async function comparePermissions() {
            addResult('üìä Comparaison des permissions', 
                'Super Admin vs Operator:\n\n' +
                'Super Admin devrait avoir:\n' +
                '- Acc√®s √† toutes les organisations\n' +
                '- Acc√®s √† tous les matchs\n' +
                '- Acc√®s √† tous les profils\n' +
                '- Permissions de cr√©ation/suppression globales\n\n' +
                'Operator devrait avoir:\n' +
                '- Acc√®s limit√© √† ses organisations\n' +
                '- Acc√®s limit√© aux matchs de ses organisations\n' +
                '- Pas d\'acc√®s aux profils d\'autres utilisateurs', 
                'info');
        }
    </script>
</body>
</html>
