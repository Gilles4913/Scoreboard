<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Setup Initial Data - Scoreboard Pro</title>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm';

    const SUPABASE_URL = 'https://llxfckxziquaxvhnafjv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxseGZja3h6aXF1YXh2aG5hZmp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzUwMTMsImV4cCI6MjA3NjYxMTAxM30.Y6ZFDb0-MGmP5qi_JnxQOX6v9mWjjO7ru7_fskr8m-I';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function setupInitialData() {
      const output = document.getElementById('output');

      try {
        output.innerHTML += '<div>üöÄ D√©but de la configuration...</div>';

        // √âtape 1: Cr√©er le Super Admin
        output.innerHTML += '<div>üëë Cr√©ation du Super Admin: gilles.guerrin@a2display.fr</div>';

        const { data: superAdminSignUp, error: superAdminError } = await supabase.auth.signUp({
          email: 'gilles.guerrin@a2display.fr',
          password: 'SuperAdmin2024!'
        });

        if (superAdminError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur Super Admin: ${superAdminError.message}</div>`;
          throw superAdminError;
        }

        const superAdminId = superAdminSignUp.user.id;
        output.innerHTML += `<div style="color: green">‚úÖ Super Admin cr√©√©: ${superAdminId}</div>`;

        // Attendre un peu pour que le trigger profile soit ex√©cut√©
        await new Promise(resolve => setTimeout(resolve, 1000));

        // √âtape 2: Cr√©er l'Op√©rateur
        output.innerHTML += '<div>üë§ Cr√©ation de l\'Op√©rateur: gilles.guerrin49@gmail.com</div>';

        const { data: operatorSignUp, error: operatorError } = await supabase.auth.signUp({
          email: 'gilles.guerrin49@gmail.com',
          password: 'Operator2024!'
        });

        if (operatorError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur Op√©rateur: ${operatorError.message}</div>`;
          throw operatorError;
        }

        const operatorId = operatorSignUp.user.id;
        output.innerHTML += `<div style="color: green">‚úÖ Op√©rateur cr√©√©: ${operatorId}</div>`;

        // Attendre un peu
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Se connecter en tant que Super Admin pour cr√©er les donn√©es
        output.innerHTML += '<div>üîê Connexion en tant que Super Admin...</div>';
        const { data: loginData, error: loginError } = await supabase.auth.signInWithPassword({
          email: 'gilles.guerrin@a2display.fr',
          password: 'SuperAdmin2024!'
        });

        if (loginError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur connexion: ${loginError.message}</div>`;
          throw loginError;
        }

        output.innerHTML += '<div style="color: green">‚úÖ Connect√© en tant que Super Admin</div>';

        // √âtape 3: Cr√©er une organisation de test
        output.innerHTML += '<div>üè¢ Cr√©ation d\'une organisation de test...</div>';

        const { data: org, error: orgError } = await supabase
          .from('orgs')
          .insert({
            name: 'Club Sportif Test',
            slug: 'club-test',
            sport: 'football'
          })
          .select()
          .single();

        if (orgError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur organisation: ${orgError.message}</div>`;
          throw orgError;
        }

        output.innerHTML += `<div style="color: green">‚úÖ Organisation cr√©√©e: ${org.name} (${org.id})</div>`;

        // √âtape 4: Ajouter le Super Admin √† l'organisation
        output.innerHTML += '<div>üëë Ajout du Super Admin √† l\'organisation...</div>';

        const { error: superAdminMemberError } = await supabase
          .from('org_members')
          .insert({
            org_id: org.id,
            user_id: superAdminId,
            role: 'super_admin'
          });

        if (superAdminMemberError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur ajout Super Admin: ${superAdminMemberError.message}</div>`;
          throw superAdminMemberError;
        }

        output.innerHTML += '<div style="color: green">‚úÖ Super Admin ajout√© √† l\'organisation</div>';

        // √âtape 5: Ajouter l'Op√©rateur √† l'organisation
        output.innerHTML += '<div>üë§ Ajout de l\'Op√©rateur √† l\'organisation...</div>';

        const { error: operatorMemberError } = await supabase
          .from('org_members')
          .insert({
            org_id: org.id,
            user_id: operatorId,
            role: 'operator'
          });

        if (operatorMemberError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur ajout Op√©rateur: ${operatorMemberError.message}</div>`;
          throw operatorMemberError;
        }

        output.innerHTML += '<div style="color: green">‚úÖ Op√©rateur ajout√© √† l\'organisation</div>';

        // √âtape 6: Cr√©er un match de test
        output.innerHTML += '<div>‚öΩ Cr√©ation d\'un match de test...</div>';

        const { data: match, error: matchError } = await supabase
          .from('matches')
          .insert({
            org_id: org.id,
            name: 'Match de Test',
            sport: 'football',
            home_name: '√âquipe A',
            away_name: '√âquipe B',
            scheduled_at: new Date().toISOString(),
            status: 'scheduled',
            public_display: true,
            created_by: superAdminId
          })
          .select()
          .single();

        if (matchError) {
          output.innerHTML += `<div style="color: red">‚ùå Erreur match: ${matchError.message}</div>`;
          throw matchError;
        }

        output.innerHTML += `<div style="color: green">‚úÖ Match cr√©√©: ${match.name} (${match.id})</div>`;

        // R√©sum√© final
        output.innerHTML += '<div style="margin-top: 20px; padding: 20px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;">';
        output.innerHTML += '<h2 style="margin: 0 0 10px 0; color: #2e7d32;">‚úÖ Configuration termin√©e avec succ√®s!</h2>';
        output.innerHTML += '<div><strong>Super Admin:</strong></div>';
        output.innerHTML += '<div>Email: gilles.guerrin@a2display.fr</div>';
        output.innerHTML += '<div>Mot de passe: SuperAdmin2024!</div>';
        output.innerHTML += '<div style="margin-top: 10px;"><strong>Op√©rateur:</strong></div>';
        output.innerHTML += '<div>Email: gilles.guerrin49@gmail.com</div>';
        output.innerHTML += '<div>Mot de passe: Operator2024!</div>';
        output.innerHTML += '<div style="margin-top: 10px;"><strong>Organisation:</strong></div>';
        output.innerHTML += `<div>Nom: ${org.name}</div>`;
        output.innerHTML += `<div>Slug: ${org.slug}</div>`;
        output.innerHTML += `<div>Sport: ${org.sport}</div>`;
        output.innerHTML += '<div style="margin-top: 15px; color: #1976d2;"><strong>Vous pouvez maintenant vous connecter √† l\'application!</strong></div>';
        output.innerHTML += '</div>';

        // Se d√©connecter
        await supabase.auth.signOut();

      } catch (error) {
        output.innerHTML += `<div style="color: red; margin-top: 20px; padding: 15px; background: #ffebee; border: 2px solid #f44336; border-radius: 8px;">`;
        output.innerHTML += `<strong>‚ùå Erreur:</strong> ${error.message}`;
        output.innerHTML += `</div>`;
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('setupBtn').addEventListener('click', setupInitialData);
    });
  </script>
  <style>
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #1976d2;
      text-align: center;
      margin-bottom: 30px;
    }
    #output {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      min-height: 200px;
      margin-top: 20px;
    }
    #output div {
      padding: 5px 0;
      font-size: 14px;
    }
    button {
      width: 100%;
      padding: 15px;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .info-box {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .info-box h3 {
      margin: 0 0 10px 0;
      color: #1976d2;
    }
    .info-box ul {
      margin: 5px 0;
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <h1>‚öΩ Scoreboard Pro - Configuration Initiale</h1>

  <div class="info-box">
    <h3>üìã Ce script va cr√©er:</h3>
    <ul>
      <li><strong>Super Admin:</strong> gilles.guerrin@a2display.fr (SuperAdmin2024!)</li>
      <li><strong>Op√©rateur:</strong> gilles.guerrin49@gmail.com (Operator2024!)</li>
      <li><strong>Organisation:</strong> Club Sportif Test (sport: football)</li>
      <li><strong>Match de test:</strong> √âquipe A vs √âquipe B</li>
    </ul>
  </div>

  <button id="setupBtn">üöÄ Lancer la configuration</button>

  <div id="output"></div>
</body>
</html>
